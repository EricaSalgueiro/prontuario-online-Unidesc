<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Prontu√°rio Online ‚Äî Sistema</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --blue:#2563eb;
    --blue-700:#1e40af;
    --muted:#6b7280;
    --bg:#f3f6fb;
    --card:#ffffff;
    --danger:#ef4444;
    --success:#16a34a;
    --radius:12px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,Arial;
    background: linear-gradient(180deg,#eef2ff 0%, #f8fafc 100%);
    color:#0f172a; padding:28px; display:flex; justify-content:center;
  }

  .app{ width:100%; max-width:1100px; }

  header{
    background:linear-gradient(90deg,var(--blue),var(--blue-700));
    color:white; padding:16px 20px; border-radius:12px; box-shadow: 0 8px 30px rgba(2,6,23,0.06);
    display:flex; align-items:center; justify-content:space-between; gap:12px;
  }
  header h1{ margin:0; font-size:18px; }

  .card{ background:var(--card); border-radius:var(--radius); padding:16px; box-shadow:0 8px 30px rgba(2,6,23,0.04); }

  .grid{ display:grid; gap:16px; }
  .two-col{ grid-template-columns: 1fr 360px; }
  .single{ grid-template-columns: 1fr; }

  label{ display:block; font-size:13px; color:var(--muted); margin-bottom:6px; font-weight:600 }
  input[type="text"], input[type="email"], input[type="password"], textarea, select{
    width:100%; padding:10px 12px; border-radius:10px; border:1px solid #e6eefc; background:#fff; font-size:14px;
  }
  textarea{ min-height:84px; resize:vertical; }

  .muted{ color:var(--muted); font-size:13px }

  .btn{
    display:inline-flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; border:none;
    background:var(--blue); color:white; font-weight:700; cursor:pointer; font-size:14px;
  }
  .btn:hover{ background:var(--blue-700) }
  .btn.ghost{ background:transparent; color:var(--blue); border:1px solid rgba(37,99,235,0.12) }
  .btn.danger{ background:var(--danger); color:white; }
  .btn.small{ padding:6px 8px; font-size:13px; border-radius:8px; }
  .btn.edit{ background:transparent; border:1px solid rgba(37,99,235,0.12); color:var(--blue) }

  .patients-list{ display:grid; gap:12px; }
  .patient-box{ display:flex; flex-direction:column; gap:8px; }

  .treatment{ background:#fbfdff; padding:10px; border-radius:10px; border:1px solid #eef6ff; }

  #fab{ position:fixed; right:24px; bottom:24px; background:var(--blue); color:white; border:none; width:56px; height:56px;
    border-radius:14px; box-shadow:0 12px 30px rgba(37,99,235,0.18); font-size:26px; cursor:pointer; display:none;
  }

  /* modal overlay */
  #overlay{ position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(2,6,23,0.45); z-index:40; }
  #modal{ width:100%; max-width:560px; border-radius:12px; padding:18px; }

  /* toast message */
  .toast{ position:fixed; top:22px; right:22px; padding:12px 16px; border-radius:10px; color:white; font-weight:600; z-index:9999;
    box-shadow:0 8px 26px rgba(2,6,23,0.25); transform:translateY(-8px); opacity:0; transition:opacity .25s, transform .25s;
  }
  .toast.show{ opacity:1; transform:translateY(0); }
  .toast.info{ background:#06b6d4; }
  .toast.success{ background:var(--success); }
  .toast.warn{ background:#f59e0b; }
  .toast.error{ background:var(--danger); }

  footer{ margin-top:18px; text-align:center; color:var(--muted); font-size:13px }

  @media(max-width:920px){
    .two-col{ grid-template-columns:1fr; }
    header{ flex-direction:column; align-items:flex-start; gap:10px; }
  }
</style>
</head>
<body>
  <div class="app">
    <header class="card">
      <h1>Prontu√°rio Online ‚Äî Sistema</h1>
      <div style="display:flex;gap:12px;align-items:center">
        <div id="userInfo" class="muted">Voc√™ n√£o est√° logado</div>
        <button id="logoutBtn" class="btn ghost" style="display:none" onclick="logout()">Sair</button>
      </div>
    </header>

    <!-- AUTH -->
    <div id="authArea" style="margin-top:18px">
      <div class="grid two-col" id="authGrid">
        <div class="card">
          <h3>Entrar</h3>
          <label>E-mail</label>
          <input id="loginEmail" type="email" placeholder="seu@exemplo.com">
          <label>Senha</label>
          <input id="loginPassword" type="password" placeholder="Senha">
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" onclick="login()">Entrar</button>
            <button class="btn ghost" onclick="showRegister()">Criar conta</button>
          </div>
          <p class="muted" style="margin-top:12px">Conta de teste: <strong>medico@exemplo.com</strong> / <strong>senha123</strong></p>
        </div>

        <div class="card" id="registerCard">
          <h3>Registrar conta</h3>
          <label>Nome completo</label>
          <input id="regName" type="text" placeholder="Nome">
          <label>E-mail</label>
          <input id="regEmail" type="email" placeholder="seu@exemplo.com">
          <label>Senha</label>
          <input id="regPassword" type="password" placeholder="Senha">
          <label>Tipo</label>
          <select id="regType">
            <option value="">-- selecione --</option>
            <option value="medico">M√©dico</option>
            <option value="paciente">Paciente</option>
          </select>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="btn" onclick="register()">Cadastrar</button>
            <button class="btn ghost" onclick="clearRegister()">Limpar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL -->
    <div id="panel" class="card" style="margin-top:18px; display:none">
      <div class="grid two-col">
        <div class="card" style="min-height:220px">
          <div id="panelBody"></div>
        </div>
        <div class="card">
          <h4>Atalhos</h4>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <button class="btn ghost" onclick="exportData()">Exportar backup</button>
            <button class="btn ghost" onclick="importData()">Importar backup</button>
            <button class="btn" id="btnAddPatientSide" style="display:none" onclick="openAddPatient()">+ Novo paciente</button>
          </div>
        </div>
      </div>
    </div>

    <footer>Feito com ‚ô•</footer>
  </div>

  <!-- FAB -->
  <button id="fab" title="Adicionar paciente" onclick="openAddPatient()">+</button>

  <!-- Modal overlay -->
  <div id="overlay">
    <div id="modal" class="card"><div id="modalContent"></div></div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast"></div>

<script>
/* =========================
   Sistema completo ‚Äî √∫nico arquivo
   ========================= */

/* Constantes storage */
const KEY_USERS = "po_users_v_final";
const KEY_CURRENT = "po_current_v_final";

/* Helpers storage */
function getUsers(){ return JSON.parse(localStorage.getItem(KEY_USERS) || "[]"); }
function saveUsers(users){ localStorage.setItem(KEY_USERS, JSON.stringify(users)); }
function genId(){ return 'id_' + Math.random().toString(36).slice(2,9); }
function getCurrent(){ return JSON.parse(localStorage.getItem(KEY_CURRENT) || "null"); }
function setCurrent(u){ localStorage.setItem(KEY_CURRENT, JSON.stringify(u)); }
function clearCurrent(){ localStorage.removeItem(KEY_CURRENT); }

/* UI refs */
const userInfo = document.getElementById('userInfo');
const logoutBtn = document.getElementById('logoutBtn');
const authArea = document.getElementById('authArea');
const panel = document.getElementById('panel');
const panelBody = document.getElementById('panelBody');
const fab = document.getElementById('fab');
const btnAddPatientSide = document.getElementById('btnAddPatientSide');
const overlay = document.getElementById('overlay');
const modalContent = document.getElementById('modalContent');
const toast = document.getElementById('toast');

/* Demo user */
(function ensureDemo(){
  const users = getUsers();
  if(!users.find(u=>u.email === "medico@exemplo.com")){
    users.push({ id: genId(), name: "Dr. Demo", email: "medico@exemplo.com", password: "senha123", type:"medico", patients: [], treatments: [] });
    saveUsers(users);
  }
})();

/* Toast (replaces alerts) */
function showToast(msg, type="info"){
  toast.className = "toast " + (type === "success" ? "success" : type === "warn" ? "warn" : type === "error" ? "error" : "info");
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=> toast.classList.remove('show'), 2800);
}

/* Auth helpers */
function clearRegister(){
  document.getElementById('regName').value = "";
  document.getElementById('regEmail').value = "";
  document.getElementById('regPassword').value = "";
  document.getElementById('regType').value = "";
  showToast("Formul√°rio limpo", "info");
}

function showRegister(){ document.getElementById('regName').focus(); showToast("Preencha os dados para registrar", "info"); }

/* Register */
function register(){
  const name = document.getElementById('regName').value.trim();
  const email = (document.getElementById('regEmail').value || '').trim().toLowerCase();
  const pass = document.getElementById('regPassword').value;
  const type = document.getElementById('regType').value;

  if(!name || !email || !pass || !type){
    showToast("Preencha todos os campos.", "warn"); return;
  }

  let users = getUsers();
  if(users.find(u => u.email === email)){
    showToast("E-mail j√° cadastrado.", "error"); return;
  }

  users.push({ id: genId(), name, email, password: pass, type, patients: [], treatments: [] });
  saveUsers(users);
  showToast("Cadastro efetuado com sucesso! Fa√ßa login.", "success");
  clearRegister();
}

/* Login */
function login(){
  const email = (document.getElementById('loginEmail').value || '').trim().toLowerCase();
  const pass = document.getElementById('loginPassword').value;
  if(!email || !pass){ showToast("Informe e-mail e senha.", "warn"); return; }

  const users = getUsers();
  const user = users.find(u => u.email === email && u.password === pass);
  if(!user){ showToast("Credenciais inv√°lidas.", "error"); return; }

  setCurrent(user);
  openPanel(user);
}

/* Open main panel */
function openPanel(user){
  authArea.style.display = 'none';
  panel.style.display = 'block';
  logoutBtn.style.display = 'inline-block';
  userInfo.textContent = `${user.name} (${user.email})`;

  if(user.type === 'medico'){
    fab.style.display = 'inline-block';
    btnAddPatientSide.style.display = 'inline-block';
    renderDoctor(user);
  } else {
    fab.style.display = 'none';
    btnAddPatientSide.style.display = 'none';
    renderPatient(user);
  }
}

/* Logout */
function logout(){
  clearCurrent();
  location.reload();
}

/* ============================
   Render m√©dico
   ============================ */
function renderDoctor(doctor){
  const users = getUsers();
  const doc = users.find(u => u.id === doctor.id);
  if(!doc){ showToast("M√©dico n√£o encontrado.", "error"); logout(); return; }

  const patients = (doc.patients || []).map(pid => users.find(u => u.id === pid)).filter(Boolean);

  let html = `<h3>üë®‚Äç‚öïÔ∏è Painel do M√©dico ‚Äî ${escapeHtml(doc.name)}</h3>`;
  html += `<p class="muted">Total de pacientes: ${patients.length}</p>`;

  if(patients.length === 0){
    html += `<div class="card" style="margin-top:12px"><p class="muted">Nenhum paciente. Use + para adicionar.</p></div>`;
    panelBody.innerHTML = html; return;
  }

  html += `<div class="patients-list" style="margin-top:12px">`;
  patients.forEach(p => {
    html += `<div class="patient-box card" id="patient_${p.id}">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong style="font-size:16px">${escapeHtml(p.name)}</strong>
          <div class="muted">${escapeHtml(p.email)}</div>
        </div>
        <div style="display:flex;gap:8px">
          <button class="btn small" onclick="openAddTreatment('${p.id}')">+ Tratamento</button>
          <button class="btn edit small" onclick="openEditPatient('${p.id}')">Editar</button>
          <button class="btn danger small" style="background:var(--danger); color:white" onclick="confirmDeletePatient('${p.id}')">Excluir</button>
        </div>
      </div>
      <div style="margin-top:12px">${renderTreatmentList(p)}</div>
    </div>`;
  });
  html += `</div>`;

  panelBody.innerHTML = html;
}

/* Treatment list for patient (with topic) */
function renderTreatmentList(patient){
  if(!patient.treatments || !patient.treatments.length) return `<p class="muted">Nenhum tratamento cadastrado.</p>`;
  let out = '';
  patient.treatments.forEach(t => {
    out += `<div class="treatment">
      <div style="display:flex;justify-content:space-between;gap:8px">
        <div>
          <strong>${escapeHtml(t.title)}</strong>
          <div class="muted" style="margin-top:6px">T√≥pico: <strong>${escapeHtml(t.topic || '‚Äî')}</strong></div>
          <p class="muted" style="margin-top:8px">${escapeHtml(t.description)}</p>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn small" onclick="openAddMedication('${patient.id}','${t.id}')">+ Medicamento</button>
          <button class="btn edit small" onclick="openEditTreatment('${patient.id}','${t.id}')">Editar</button>
          <button class="btn danger small" style="background:var(--danger);color:white" onclick="deleteTreatment('${patient.id}','${t.id}')">Excluir</button>
        </div>
      </div>
      <div style="margin-top:10px">${renderMedications(patient.id, t)}</div>
    </div>`;
  });
  return out;
}

/* Render medications - pass patientId so buttons know context */
function renderMedications(patientId, treat){
  if(!treat.medications || !treat.medications.length) return `<p class="muted">Nenhum medicamento cadastrado.</p>`;
  let s = '<ul style="margin:6px 0 0 18px">';
  treat.medications.forEach(m => {
    s += `<li style="margin-bottom:8px">
      <strong>${escapeHtml(m.name)}</strong> ‚Äî ${escapeHtml(m.instructions)} ${m.duration ? `(${escapeHtml(m.duration)})` : ''}
      <div style="margin-top:6px;display:flex;gap:8px">
        <button class="btn small edit" onclick="openEditMedication('${patientId}','${treat.id}','${m.id}')">Editar</button>
        <button class="btn danger small" style="background:var(--danger);color:white" onclick="deleteMedication('${patientId}','${treat.id}','${m.id}')">Excluir</button>
      </div>
    </li>`;
  });
  s += '</ul>';
  return s;
}

/* ============================
   Render paciente
   ============================ */
function renderPatient(patient){
  const users = getUsers();
  const p = users.find(u => u.id === patient.id);
  if(!p){ showToast("Paciente n√£o encontrado.", "error"); logout(); return; }

  let html = `<h3>üíä Painel do Paciente ‚Äî ${escapeHtml(p.name)}</h3><p class="muted">${escapeHtml(p.email)}</p>`;
  if(!p.treatments || !p.treatments.length){ html += `<p class="muted" style="margin-top:12px">Nenhum tratamento registrado.</p>`; }
  else {
    html += `<div class="patients-list" style="margin-top:12px">`;
    p.treatments.forEach(t => {
      html += `<div class="card">
        <strong>${escapeHtml(t.title)}</strong>
        <div class="muted">T√≥pico: <strong>${escapeHtml(t.topic || '‚Äî')}</strong></div>
        <p class="muted">${escapeHtml(t.description)}</p>
        <div style="margin-top:8px">${renderMedications(p.id, t)}</div>
      </div>`;
    });
    html += `</div>`;
  }
  panelBody.innerHTML = html;
}

/* ============================
   MODAIS & A√á√ïES
   ============================ */
function showModal(html){ overlay.style.display='flex'; modalContent.innerHTML = html; }
function closeModal(){ overlay.style.display='none'; modalContent.innerHTML = ''; }

/* ADD PATIENT: improved logic (associate existing patient / create new) */
function openAddPatient(){
  showModal(`<h3>Adicionar Paciente</h3>
    <label>Nome</label><input id="m_name" type="text">
    <label>E-mail</label><input id="m_email" type="email">
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveNewPatient()">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveNewPatient(){
  const name = (document.getElementById('m_name').value || '').trim();
  const email = (document.getElementById('m_email').value || '').trim().toLowerCase();

  if(!name || !email){ showToast("Preencha nome e e-mail.", "warn"); return; }

  const users = getUsers();
  const current = getCurrent();
  if(!current){ showToast("Sess√£o expirada. Fa√ßa login novamente.", "error"); return; }

  // find doctor in user list
  const docIdx = users.findIndex(u => u.id === current.id);
  if(docIdx === -1){ showToast("M√©dico n√£o encontrado.", "error"); return; }

  // search for existing patient by email
  const existingPatient = users.find(u => u.email === email && u.type === "paciente");

  if(existingPatient){
    // associate patient with doctor if not already associated
    users[docIdx].patients = users[docIdx].patients || [];
    if(!users[docIdx].patients.includes(existingPatient.id)){
      users[docIdx].patients.push(existingPatient.id);
      saveUsers(users);
      setCurrent(users[docIdx]);
      closeModal();
      openPanel(users[docIdx]);
      showToast("Paciente existente associado √† sua lista.", "success");
      return;
    } else {
      showToast("Esse paciente j√° est√° na sua lista.", "info");
      return;
    }
  }

  // create new patient
  const newP = { id: genId(), name, email, password: "123456", type: "paciente", patients: [], treatments: [] };
  users.push(newP);
  users[docIdx].patients = users[docIdx].patients || [];
  users[docIdx].patients.push(newP.id);
  saveUsers(users);
  setCurrent(users[docIdx]);
  closeModal();
  openPanel(users[docIdx]);
  showToast("Paciente criado e adicionado com sucesso!", "success");
}

/* ADD TREATMENT (includes topic) */
function openAddTreatment(pid){
  showModal(`<h3>Novo Tratamento</h3>
    <label>T√≠tulo</label><input id="t_title" type="text">
    <label>T√≥pico</label><input id="t_topic" type="text" placeholder="Ex: Cardiologia, Fisioterapia...">
    <label>Descri√ß√£o</label><textarea id="t_desc"></textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveNewTreatment('${pid}')">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveNewTreatment(pid){
  const title = (document.getElementById('t_title').value || '').trim();
  const topic = (document.getElementById('t_topic').value || '').trim();
  const desc = (document.getElementById('t_desc').value || '').trim();

  if(!title || !desc){ showToast("Preencha t√≠tulo e descri√ß√£o.", "warn"); return; }

  const users = getUsers();
  const p = users.find(u => u.id === pid);
  if(!p){ showToast("Paciente n√£o encontrado.", "error"); closeModal(); return; }
  p.treatments = p.treatments || [];
  p.treatments.push({ id: genId(), title, topic, description: desc, medications: [] });
  saveUsers(users);
  closeModal();
  openPanel(getCurrent());
  showToast("Tratamento adicionado.", "success");
}

/* ADD MEDICATION */
function openAddMedication(pid, tid){
  showModal(`<h3>Novo Medicamento</h3>
    <label>Nome</label><input id="med_name" type="text">
    <label>Instru√ß√µes</label><input id="med_instr" type="text">
    <label>Dura√ß√£o</label><input id="med_duration" type="text">
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveNewMedication('${pid}','${tid}')">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveNewMedication(pid, tid){
  const name = (document.getElementById('med_name').value || '').trim();
  const instr = (document.getElementById('med_instr').value || '').trim();
  const dur = (document.getElementById('med_duration').value || '').trim();

  if(!name){ showToast("Nome do medicamento √© obrigat√≥rio.", "warn"); return; }

  const users = getUsers();
  const p = users.find(u => u.id === pid);
  if(!p){ showToast("Paciente n√£o encontrado.", "error"); closeModal(); return; }
  const t = p.treatments.find(x => x.id === tid);
  if(!t){ showToast("Tratamento n√£o encontrado.", "error"); closeModal(); return; }
  t.medications = t.medications || [];
  t.medications.push({ id: genId(), name, instructions: instr, duration: dur });
  saveUsers(users);
  closeModal(); openPanel(getCurrent());
  showToast("Medicamento adicionado.", "success");
}

/* EDIT / DELETE actions */
function openEditPatient(pid){
  const users = getUsers(); const p = users.find(u => u.id === pid);
  if(!p){ showToast("Paciente n√£o encontrado.", "error"); return; }
  showModal(`<h3>Editar Paciente</h3>
    <label>Nome</label><input id="ep_name" type="text" value="${escapeHtml(p.name)}">
    <label>E-mail</label><input id="ep_email" type="email" value="${escapeHtml(p.email)}">
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveEditPatient('${pid}')">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveEditPatient(pid){
  const name = (document.getElementById('ep_name').value || '').trim();
  const email = (document.getElementById('ep_email').value || '').trim().toLowerCase();
  if(!name || !email){ showToast("Preencha nome e e-mail.", "warn"); return; }

  const users = getUsers();
  if(users.find(u => u.email === email && u.id !== pid)){ showToast("Outro usu√°rio j√° possui este e-mail.", "error"); return; }

  const idx = users.findIndex(u => u.id === pid);
  users[idx].name = name; users[idx].email = email;
  saveUsers(users);
  closeModal();
  openPanel(getCurrent());
  showToast("Paciente atualizado.", "success");
}

function confirmDeletePatient(pid){
  if(!confirm("Deseja realmente excluir este paciente?")) return;
  let users = getUsers();
  users.forEach(u => { if(u.type === 'medico' && u.patients) u.patients = u.patients.filter(x => x !== pid); });
  users = users.filter(u => u.id !== pid);
  saveUsers(users);
  openPanel(getCurrent());
  showToast("Paciente exclu√≠do.", "success");
}

/* Edit treatment */
function openEditTreatment(pid, tid){
  const users = getUsers(); const p = users.find(u => u.id === pid); const t = p.treatments.find(x => x.id === tid);
  if(!t){ showToast("Tratamento n√£o encontrado.", "error"); return; }
  showModal(`<h3>Editar Tratamento</h3>
    <label>T√≠tulo</label><input id="et_title" type="text" value="${escapeHtml(t.title)}">
    <label>T√≥pico</label><input id="et_topic" type="text" value="${escapeHtml(t.topic || '')}">
    <label>Descri√ß√£o</label><textarea id="et_desc">${escapeHtml(t.description)}</textarea>
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveEditTreatment('${pid}','${tid}')">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveEditTreatment(pid, tid){
  const title = (document.getElementById('et_title').value || '').trim();
  const topic = (document.getElementById('et_topic').value || '').trim();
  const desc = (document.getElementById('et_desc').value || '').trim();
  if(!title || !desc){ showToast("Preencha t√≠tulo e descri√ß√£o.", "warn"); return; }

  const users = getUsers(); const p = users.find(u => u.id === pid); const t = p.treatments.find(x => x.id === tid);
  t.title = title; t.topic = topic; t.description = desc;
  saveUsers(users); closeModal(); openPanel(getCurrent()); showToast("Tratamento atualizado.", "success");
}

/* Edit medication */
function openEditMedication(pid, tid, mid){
  const users = getUsers(); const p = users.find(u => u.id === pid); const t = p.treatments.find(x => x.id === tid); const m = t.medications.find(x => x.id === mid);
  if(!m){ showToast("Medicamento n√£o encontrado.", "error"); return; }
  showModal(`<h3>Editar Medicamento</h3>
    <label>Nome</label><input id="em_name" type="text" value="${escapeHtml(m.name)}">
    <label>Instru√ß√µes</label><input id="em_instr" type="text" value="${escapeHtml(m.instructions)}">
    <label>Dura√ß√£o</label><input id="em_duration" type="text" value="${escapeHtml(m.duration || '')}">
    <div style="display:flex;gap:8px;margin-top:8px"><button class="btn" onclick="saveEditMedication('${pid}','${tid}','${mid}')">Salvar</button><button class="btn ghost" onclick="closeModal()">Cancelar</button></div>`);
}

function saveEditMedication(pid, tid, mid){
  const name = (document.getElementById('em_name').value || '').trim();
  const instr = (document.getElementById('em_instr').value || '').trim();
  const dur = (document.getElementById('em_duration').value || '').trim();
  if(!name){ showToast("Nome obrigat√≥rio.", "warn"); return; }

  const users = getUsers(); const p = users.find(u => u.id === pid); const t = p.treatments.find(x => x.id === tid);
  const m = t.medications.find(x => x.id === mid);
  m.name = name; m.instructions = instr; m.duration = dur;
  saveUsers(users); closeModal(); openPanel(getCurrent()); showToast("Medicamento atualizado.", "success");
}

function deleteMedication(pid, tid, mid){
  if(!confirm("Excluir medicamento?")) return;
  const users = getUsers(); const p = users.find(u => u.id === pid); const t = p.treatments.find(x => x.id === tid);
  t.medications = t.medications.filter(x => x.id !== mid); saveUsers(users); openPanel(getCurrent()); showToast("Medicamento exclu√≠do.", "success");
}

/* Export / Import backup */
function exportData(){
  const data = { exportedAt: new Date().toISOString(), users: getUsers() };
  const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'prontuario_backup.json'; a.click(); URL.revokeObjectURL(a.href);
  showToast("Backup exportado.", "success");
}
function importData(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e => {
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader(); r.onload = ev => {
      try{
        const parsed = JSON.parse(ev.target.result);
        if(!parsed.users) throw new Error('Formato inv√°lido');
        const existing = getUsers(); const merged = [...existing];
        parsed.users.forEach(u => { if(!merged.find(x => x.email === u.email)) merged.push(u); });
        saveUsers(merged); showToast("Importa√ß√£o conclu√≠da.", "success");
        if(getCurrent()){ const cur = getUsers().find(x => x.email === getCurrent().email); if(cur){ setCurrent(cur); openPanel(cur); } }
      }catch(err){ showToast("Erro: " + err.message, "error"); }
    }; r.readAsText(f);
  };
  inp.click();
}

/* Escape helper for safety */
function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"'`]/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','`':'&#96;'})[m]); }

/* Quick alias to keep previous naming consistent */
function escape(s){ return escapeHtml(s); }

/* Overlay close on click outside */
overlay.addEventListener('click', (e)=>{ if(e.target === overlay) closeModal(); });

/* On load restore session */
window.addEventListener('load', ()=>{
  const cur = getCurrent();
  if(cur) openPanel(cur);
});
</script>
</body>
</html>
